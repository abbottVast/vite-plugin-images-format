/*!
 * vite-plugin-images-format v1.0.0
 * (c) Sat Apr 27 2024 17:14:43 GMT+0800 (中国标准时间) lbr
 * Released under the MIT License.
 */
"use strict";var e=require("fs"),t=require("path"),r=require("sharp");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=n(e),i=n(t),c=n(r);function l(e){try{return window.eval(e)}catch(t){return e}}var o={toArray:function(e){return"string"==typeof e?e?[e]:[]:e},isDirectory:function(e){return a.default.statSync(e).isDirectory()},evalCatch:l,isTargetImage:function(e,t){const r=l(e).split("."),n=r[r.length-1];return t.includes(`.${n}`)},getWebpPath:function(e,t,r,n){const a=e.split("."),i=a[a.length-1],c=new RegExp(`${i}$`);return e.replace(c,n).replace(t,r)},rtnSameStr:function(e,t){for(var r=e.length>t.length?t.length:e.length,n=0;n<r&&e[n]===t[n];)n++;return e.substr(0,n)}};const s=/\D+(\d+)[xX*](\d+)\.webp$/;function u(e,t,r){if(!1===a.default.existsSync(e))return r;const{imageType:n,entry:l,outDir:p,sharpType:f}=t;a.default.readdirSync(e).forEach((h=>{const d=i.default.join(e,h);o.isDirectory(d)?u(d,t,r):o.isTargetImage(d,n)&&(Array.isArray(f)?f.forEach((e=>{const t=o.getWebpPath(d,l,p,e),n=i.default.parse(t);a.default.existsSync(n.dir)&&a.default.mkdirSync(n.dir);const u=o.rtnSameStr(l,p);r.push({old:d.replace(u,""),new:t.replace(u,"")}),((e,t,r)=>{let n=null,a=null;s.lastIndex=0,s.test(t)&&(n=Number(RegExp.$1),a=Number(RegExp.$2)),new Promise(((i,l)=>{if("avif"===r)try{c.default(e).resize({width:n,height:a}).avif().toFile(t,((e,t)=>{e?l(e):i(t)}))}catch(e){l(e)}else try{c.default(e).resize({width:n,height:a}).webp().toFile(t,((e,t)=>{e?l(e):i(t)}))}catch(e){l(e)}}))})(d,t,e)})):console.error("sharpType需为数组"))}))}module.exports=function(e={}){const t=Object.assign({entry:"",imageType:[".png",".jpg"],sharpType:["webp"],outDir:"",isReplacePath:!0,replaceList:[".vue"]},e);let r=[];((e,t)=>{const{entry:r}=e,n=o.toArray(r);for(let r=0;r<n.length;r++)u(n[r],e,t)})(t,r);const n=o.rtnSameStr(t.entry,t.outDir);return r=r.map((e=>({old:e.old.replace(n,""),new:e.new.replace(n,"")}))),{name:"vite-plugin-images-format",enforce:"pre",transform(e,n){let a=e;return t.isReplacePath&&t.replaceList.forEach((e=>{n.endsWith(e)&&r.forEach((e=>{a=a.replaceAll(e.old,e.new)}))})),a}}};
